#include "level.h"

Level::Level(const std::string& data) : name_(""), fuel_(0), start_(0, 0), pad_(0, 0), terrain_() {
  name_ = data.substr(1, (unsigned char) data.at(0));
  size_t offset = (unsigned char) data.at(0) + 1;

  fuel_ = (unsigned char) data.at(offset++);
  start_.x = (unsigned char) data.at(offset++);
  start_.y = 256 - (unsigned char) data.at(offset++);
  pad_.x = (unsigned char) data.at(offset++);
  pad_.y = 256 - (unsigned char) data.at(offset++);

  const size_t segments = (unsigned char) data.at(offset++);
  for (size_t i = 0; i < segments; ++i) {
    const size_t length = (unsigned char) data.at(offset++);
    PolyLine seg;
    for (size_t j = 0; j < length; ++j) {
      const int x = (unsigned char) data.at(offset++);
      const int y = 256 - (unsigned char) data.at(offset++);
      seg.add(x, y);
    }
    terrain_.emplace_back(seg);
  }
}

void Level::draw(Graphics& graphics) const {
  for (const auto& p : terrain_) {
    p.draw(graphics, 0x00ff00ff);
  }
  const SDL_Rect r = { pad_.x - 7.5, pad_.y, 15, 5 };
  graphics.draw_rect(&r, 0xffffffff, false);
}

Point Level::get_start() const {
  return start_;
}

Point Level::get_pad() const {
  return pad_;
}

int Level::get_fuel() const {
  return fuel_;
}

bool Level::intersect(const PolyLine& poly) const {
  for (const auto& seg : terrain_) {
    if (seg.intersect(poly)) return true;
  }
  return false;
}

const std::string Level::kLevelData[21] = {
  { "\x06\x53\x65\x63\x72\x65\x74\x10\x10\x28\xf0\x17\x04\x20\x04\x1b\x10\xe3"
    "\x38\xef\x4c\x4f\x4c\xef\x60\xef\x64\x47\x90\x53\x98\xef\xb8\xe3\xc4\x4b"
    "\xc4\xe3\xd0\xe3\xec\x9b\xe4\xdf\xfc\xcb\xf8\x17\xe8\x17\xe4\x6f\xd8\x97"
    "\xd0\x07\xb8\x17\xb4\x63\xa0\x57\x9c\x17\x8c\x27\x4c\x0b\x4c\x2b\x34\x2f"
    "\x2c\x63\x1c\x53\x18\x0f\x02\x18\x0f\x04\x1b\x04\x18\x77\x20\xbf\x34\x93"
    "\x18\x77\x04\xa0\xaf\x9c\x83\xb0\x8f\xa0\xaf", 101 },
  { "\x08\x54\x72\x61\x69\x6e\x69\x6e\x67\x10\xc0\xd0\x60\x80\x01\x09\x00\x20"
    "\x30\x40\x50\x80\x70\x80\x80\x70\xa0\xa0\xd0\x90\xf0\x60\xff\x50", 34 },
  { "\x08\x4d\x6f\x75\x6e\x74\x61\x69\x6e\x10\xc0\xd0\x48\xa0\x01\x0b\x00\x10"
    "\x30\x20\x40\xa0\x50\xa0\x70\x70\x90\x80\xa0\x50\xb0\x60\xd0\x70\xf0\x40"
    "\xff\x30", 38 },
  { "\x0a\x54\x77\x69\x6e\x20\x50\x65\x61\x6b\x73\x10\xe0\xa0\x38\x20\x01\x0b"
    "\x00\x70\x20\x60\x30\x20\x40\x20\x60\x40\x70\x70\x90\x60\xa0\xb0\xc0\x80"
    "\xe0\x70\xff\x70", 40 },
  { "\x06\x43\x72\x61\x74\x65\x72\x10\x10\x40\xc8\x20\x01\x0b\x00\x10\x20\x20"
    "\x40\x40\x60\x70\x80\x90\xa0\xa0\xb0\xa0\xc0\x20\xd0\x20\xe0\xe0\xff\xf0", 36 },
  { "\x06\x43\x61\x76\x65\x72\x6e\x10\xe0\x80\x38\x30\x01\x14\x00\xe0\x10\xe0"
    "\x40\xd0\x50\xb0\x40\xa0\x20\x90\x10\x70\x10\x60\x20\x40\x30\x30\x40\x30"
    "\x60\x40\x70\x50\x70\x70\x60\x90\x70\xa0\xa0\x90\xd0\x50\xf0\x40\xff\x40", 54 },
  { "\x0d\x41\x73\x74\x65\x72\x6f\x69\x64\x20\x42\x65\x6c\x74\x10\x88\xe0\x88"
    "\x10\x04\x08\x00\x20\x20\x10\x50\x20\x70\x10\xb0\x10\xd0\x20\xe0\x20\xff"
    "\x20\x07\x20\x80\x30\x80\x50\x60\x50\x50\x40\x40\x10\x60\x20\x80\x08\x50"
    "\x90\x60\xa0\x80\xb0\x90\xa0\x80\x70\x70\x60\x50\x70\x50\x90\x09\x90\x70"
    "\xa0\x80\xc0\x90\xe0\x80\xf0\x70\xe0\x50\xd0\x40\xb0\x50\x90\x70", 88 },
  { "\x05\x43\x68\x61\x73\x6d\x10\x80\xf0\xc8\x10\x02\x12\x00\xe0\x60\xd0\x70"
    "\xb0\x60\x90\x40\x80\x20\x60\x20\x40\x30\x20\x50\x10\xd0\x10\xe0\x20\xe0"
    "\x60\xd0\x70\xb0\x80\xa0\x90\x90\xb0\xa0\xd0\xff\xe0\x09\x80\xa0\x90\x80"
    "\xd0\x60\xd0\x40\xc0\x30\x50\x50\x60\x70\x70\x80\x80\xa0", 68 },
  { "\x06\x54\x75\x6e\x6e\x65\x6c\x10\x30\xe0\xd0\x10\x01\x20\x00\xd0\x30\xc0"
    "\x50\xd0\x80\xb0\xa0\xc0\xc0\xb0\xb0\x90\x90\xa0\x80\x90\x60\x80\x40\x80"
    "\x30\x70\x20\x50\x30\x30\x50\x20\x70\x30\xa0\x20\xc0\x10\xe0\x10\xf0\x20"
    "\xf0\x30\xe0\x40\xc0\x50\xa0\x40\x70\x50\x60\x40\x50\x50\x70\x60\xa0\x70"
    "\xc0\x70\xe0\xc0\xff\xd0", 78 },
  { "\x06\x53\x70\x69\x72\x61\x6c\x10\x20\xe0\x80\x5f\x02\x20\x00\xdf\x18\xcf"
    "\x20\x9f\x18\x57\x20\x27\x30\x17\x50\x0f\x78\x17\xa8\x0f\xc8\x07\xd8\x17"
    "\xe8\x2f\xf0\x47\xf8\x6f\xf0\x9f\xd8\xb7\xc0\xbf\xa0\xc7\x80\xbf\x70\xb7"
    "\x68\x9f\x70\x6f\x78\x5f\x88\x5f\x90\x6f\x98\x87\xa8\x97\xc0\x8f\xc8\x7f"
    "\xd8\x67\xd0\x47\xb8\x37\x0b\xb8\x37\x90\x47\x68\x3f\x50\x4f\x40\x67\x30"
    "\x87\x38\xaf\x48\xc7\x58\xdf\x70\xef\x78\xff", 101 },
  { "\x06\x53\x70\x6c\x69\x74\x73\x10\xd0\xe0\xc0\x17\x02\x19\x00\xc7\x28\xd7"
    "\x48\xd7\x58\xc7\x48\x97\x58\x77\x38\x57\x38\x37\x58\x17\x88\x37\xc8\x77"
    "\xd8\x67\xd8\x57\xb8\x27\xb8\x17\xc8\x17\xe8\x57\xe8\x87\xc8\x97\x98\x67"
    "\x88\x87\xa8\x97\xb8\xb7\xc8\xc7\xff\xd7\x0e\x68\xc7\x58\x97\x68\x77\x58"
    "\x57\x68\x37\x88\x57\x78\x77\x80\x87\x78\x97\x98\xa7\xa8\xb7\x98\xc7\x78"
    "\xd7\x68\xc7", 93 },
  { "\x05\x53\x6e\x61\x6b\x65\x10\x10\x40\xe0\x17\x02\x20\x18\xff\x20\xd7\x18"
    "\xc7\x28\xbf\x50\xcf\x80\xd7\xc0\xcf\xf0\xbf\xf8\xa7\xf0\x7f\xd8\x77\xb0"
    "\x87\x70\x67\x68\x4f\x78\x3f\xa8\x6f\xc0\x67\xe8\x47\xf0\x2f\xe8\x17\xd8"
    "\x17\xc8\x3f\xa8\x4f\x80\x1f\x60\x17\x48\x47\x58\x77\x88\x9f\xc8\x97\xd0"
    "\x9f\xc8\xaf\x98\xb7\x09\x98\xb7\x70\xaf\x30\x97\x28\x87\x30\x6f\x28\x3f"
    "\x20\x1f\x10\x17\x00\x1f", 96 },
  { "\x04\x4a\x61\x77\x73\x10\x80\xe0\x98\x27\x01\x18\x00\xbf\x68\xdf\x40\xbf"
    "\x48\x9f\x78\xbf\x58\x8f\x60\x67\x88\x97\x68\x4f\x90\x6f\x78\x2f\x90\x27"
    "\xa0\x27\xb8\x2f\xa0\x6f\xc8\x4f\xa8\x97\xd0\x67\xd8\x8f\xb8\xbf\xe8\x9f"
    "\xf0\xbf\xc8\xdf\xff\xd7", 60 },
  { "\x08\x31\x33\x20\x46\x69\x65\x6c\x64\x10\x18\x30\xf0\xd7\x08\x09\xe8\xff"
    "\xf8\xd7\xe8\xd7\xe8\xd3\xf8\xa7\xf0\x7f\xe0\x4f\xe8\x27\xf0\x00\x02\xd8"
    "\x07\xd8\x07\x08\xe0\x00\xc8\x17\xa0\x0f\x78\x1f\x60\x07\x30\x17\x18\x07"
    "\x00\x0f\x09\xc0\xef\xd0\xdf\xc8\xd7\xd0\xc7\xc8\xbf\xb8\xc7\xb0\xd7\xb8"
    "\xdf\xc0\xef\x08\xd8\x87\xe8\x77\xe0\x67\xd0\x5f\xc0\x6f\xd0\x77\xc8\x7f"
    "\xd8\x87\x09\xb0\xbf\xa0\xb7\x98\xa7\xa0\x9f\xb0\x97\xb8\x9f\xa8\xaf\xb8"
    "\xb7\xb0\xbf\x0d\x40\xaf\x58\xb7\x78\x9f\x90\x97\xb0\x77\xb8\x5f\xb0\x3f"
    "\x90\x37\x70\x4f\x60\x6f\x48\x77\x38\x8f\x40\xaf\x0c\x08\xbf\x10\xd7\x20"
    "\xdf\x28\xcf\x20\xc7\x30\xbf\x38\xaf\x30\x9f\x20\x97\x18\xa7\x08\xb7\x08"
    "\xbf", 163 },
  { "\x04\x4d\x6f\x6c\x65\x10\xd8\xe8\x50\x17\x01\x14\x00\xdf\x48\xe7\x78\xd7"
    "\x90\xdf\x90\x5f\x78\x4f\x70\x3f\x60\x37\x48\x47\x38\x30\x48\x17\x58\x17"
    "\x68\x27\x80\x2f\x98\x3f\x98\xdf\xb0\xcf\xc8\xd7\xf0\xcf\xff\xd7", 52 },
  { "\x07\x56\x6f\x6c\x63\x61\x6e\x6f\x10\x30\x50\x88\x10\x03\x16\x00\x10\x20"
    "\x10\x40\x20\x50\x30\x70\xc0\x80\xd0\x90\xa0\x80\x80\x70\x50\x90\x30\x80"
    "\x10\x90\x10\xa0\x30\x80\x50\x90\x80\xa0\xa0\x90\xd0\xa0\xc0\xc0\x30\xd0"
    "\x20\xf0\x10\xff\x10\x05\x30\xc0\x50\xd0\x60\xc0\x50\xa0\x30\xc0\x05\xa0"
    "\xe0\xb0\xf0\xd0\xe0\xb0\xc0\xa0\xe0", 81 },
  { "\x06\x53\x70\x69\x6b\x65\x73\x10\x18\x30\xd8\x1f\x02\x0d\x00\x1f\x20\x17"
    "\x30\x1f\x40\xbf\x50\x1f\x68\x17\x80\x1f\x90\xbf\xa0\x1f\xb8\x17\xd0\x1f"
    "\xe0\x1f\xff\x2f\x0d\x00\xef\x20\xe7\x40\xd7\x58\xcf\x68\x3f\x78\xcf\x90"
    "\xd7\xa8\xcf\xb8\x3f\xc8\xcf\xd8\xef\xd0\xff\xd0\xff", 67 },
  { "\x05\x54\x6f\x77\x65\x72\x10\x20\x40\x80\x0f\x02\x0a\x00\x0f\x50\x0f\x68"
    "\xb7\x70\xb7\x78\x0f\x88\x0f\x90\xb7\x98\xb7\xb0\x0f\xff\x0f\x08\x68\xc7"
    "\x70\xf7\x90\xf7\x98\xc7\x88\xc7\x80\x6f\x78\xc7\x68\xc7", 50 },
  { "\x08\x46\x6f\x72\x74\x72\x65\x73\x73\x18\x18\xd8\xb8\x27\x08\x0e\x00\x8f"
    "\x30\xbf\x58\x87\x30\x47\x78\x0f\xb0\x27\xc0\x27\xe8\x37\xd8\x67\x98\x47"
    "\x60\x57\xd0\x6f\x90\xdf\xff\xc7\x05\x40\xbf\x40\xb7\x70\xb7\x70\xbf\x40"
    "\xbf\x05\x68\xa7\x68\x9f\xa8\x9f\xa8\xa7\x68\xa7\x05\x58\x7f\x58\x77\x90"
    "\x77\x90\x7f\x58\x7f\x06\x60\x37\x60\x37\x60\x2f\x90\x2f\x90\x37\x60\x37"
    "\x05\x48\x5f\x48\x3f\x50\x3f\x50\x5f\x48\x5f\x05\xa0\x97\xa0\x6f\xa8\x6f"
    "\xa8\x97\xa0\x97\x05\xb4\x38\xbc\x38\xbc\x40\xb4\x40\xb4\x38", 123 },
  { "\x06\x41\x73\x63\x65\x6e\x74\x10\x80\x20\x2c\x47\x02\x1f\x00\x17\x48\x27"
    "\x70\x4f\xa0\x67\xc8\x6f\xd0\x87\xc8\xa7\xa0\xbf\x88\x87\x60\x7f\x50\x8f"
    "\x38\x97\x30\x6f\x34\x47\x24\x47\x28\x6f\x18\xab\x28\xc3\x54\xa3\x70\x93"
    "\x8c\xd7\xb0\xc7\xd8\xb7\xe0\x97\xd4\x5f\xa4\x43\xa0\x2b\xb0\x1b\xf0\x17"
    "\xff\x17\xff\x17\x02\x00\x07\xff\x07", 81 },
  { "\x04\x42\x61\x73\x65\x20\x68\xc8\x68\x9f\x02\x19\x40\x9f\x40\xaf\x90\xaf"
    "\x90\x7f\x70\x7f\x70\x6f\x90\x6f\x90\x4f\xb0\x4f\xb0\x3f\x20\x3f\x20\x6f"
    "\x40\x6f\x40\x7f\x20\x7f\x20\xcf\x40\xcf\x40\xef\xb0\xef\xb0\x5f\xa0\x5f"
    "\xa0\xbf\x80\xbf\x80\xcf\xa0\xcf\x15\xa0\xcf\xa0\xdf\x70\xdf\x70\xbf\x60"
    "\xbf\x60\xdf\x50\xdf\x50\xbf\x30\xbf\x30\x8f\x50\x8f\x50\x5f\x30\x5f\x30"
    "\x4f\x80\x4f\x80\x5f\x60\x5f\x60\x8f\x80\x8f\x80\x9f\x40\x9f", 105 },
};
